<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
  <title>New Year 2026 Event ‚Ä¢ SIM </title>
  <style>
    :root{
      --bg:#0b0f19; --card:#121a2b; --ink:#f3f4f6; --muted:#a7b0c0; --line:#22304d;
      --btn:#22c55e; --btn2:#60a5fa; --danger:#ef4444;
    }
    *{box-sizing:border-box; -webkit-tap-highlight-color:transparent;}
    body{margin:0; background:radial-gradient(1200px 600px at 20% -10%, #23395d 0%, transparent 60%),
                     radial-gradient(900px 500px at 110% 10%, #1d3a2a 0%, transparent 60%),
                     var(--bg);
         color:var(--ink); font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Arial;
    }
    .wrap{max-width:720px; margin:0 auto; padding:20px 16px 40px;}
    .hero{padding:18px 16px; border:1px solid var(--line); border-radius:18px; background:rgba(18,26,43,.75);
          backdrop-filter: blur(10px);}
    h1{margin:0; font-size:clamp(26px,4.6vw,42px); letter-spacing:.2px;}
    .sub{margin:8px 0 0; color:var(--muted); line-height:1.4}
    .card{margin-top:14px; padding:16px; border:1px solid var(--line); border-radius:18px; background:rgba(18,26,43,.70);}
    label{display:block; font-size:14px; color:var(--muted); margin:12px 0 6px;}
    input, textarea{
      width:100%; border-radius:14px; border:1px solid #2a3b5f; background:#0e1526; color:var(--ink);
      padding:12px 12px; font-size:16px; outline:none;
    }
    textarea{min-height:110px; resize:vertical;}
    .row{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    @media (max-width:560px){ .row{grid-template-columns:1fr;} }
    .actions{display:flex; gap:10px; flex-wrap:wrap; margin-top:14px;}
    button{
      border:0; border-radius:14px; padding:12px 14px; font-weight:700; cursor:pointer; font-size:16px;
    }
    .btn{background:var(--btn); color:#05210f; flex:1;}
    .btn2{background:var(--btn2); color:#06162d;}
    .ghost{background:transparent; color:var(--muted); border:1px solid var(--line);}
    .hint{font-size:13px; color:var(--muted); margin-top:10px; line-height:1.45;}
    .preview{margin-top:10px; display:none;}
    .preview img{width:100%; max-height:320px; object-fit:contain; border-radius:16px; border:1px solid var(--line);}
    .status{margin-top:10px; padding:10px 12px; border-radius:14px; display:none; border:1px solid var(--line);}
    .ok{background:rgba(34,197,94,.12); color:#bff7d0;}
    .bad{background:rgba(239,68,68,.12); color:#ffd0d0;}
    .tiny{font-size:12px; color:var(--muted); margin-top:12px;}
  </style>

  <script src="https://unpkg.com/heic2any/dist/heic2any.min.js"></script>

</head>
<body>
  <div class="wrap">
    <div class="hero">
      <h1>üéä New Year 2026 Event ‚Ä¢ SIM </h1>
      <p class="sub">‡∏™‡πà‡∏á‡∏ó‡πâ‡∏≤‡∏¢‡∏õ‡∏µ‡πÄ‡∏Å‡πà‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥ ‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏î‡∏µ‡∏Å‡∏ß‡πà‡∏≤‡πÄ‡∏î‡∏¥‡∏°</p>
      <div class="tiny">Tip: ‡∏ù‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠ + ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° + ‡∏£‡∏π‡∏õ‡∏ñ‡πà‡∏≤‡∏¢‡πÑ‡∏ß‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥ ‚ú® (‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô)</div>
      <div class="tiny">Tip: ‡∏ñ‡πà‡∏≤‡∏¢‡∏£‡∏π‡∏õ‡πÅ‡∏ô‡∏ß‡∏ô‡∏≠‡∏ô‡∏Å‡πá‡πÑ‡∏î‡πâ ‡πÅ‡∏ï‡πà‡πÅ‡∏ô‡∏ß‡∏ï‡∏±‡πâ‡∏á‡∏à‡∏∞‡πÇ‡∏ä‡∏ß‡πå‡∏™‡∏ß‡∏¢‡∏ö‡∏ô‡∏™‡πÑ‡∏•‡∏î‡πå‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤</div>
      
    </div>

    <div class="card">
      <form id="form">
        <div class="row">
          <div>
            <label>‡∏ä‡∏∑‡πà‡∏≠ / Nickname *</label>
            <input id="name" required maxlength="60" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Å‡∏±‡∏ç‡∏ç‡πå / Soulx /‡∏Ø‡∏•‡∏Ø"/>
          </div> 
          <div>
            <label>‡πÅ‡∏ú‡∏ô‡∏Å/‡∏ó‡∏µ‡∏° (optional)</label>
            <input id="team" maxlength="60" placeholder="‡πÄ‡∏ä‡πà‡∏ô Process / EN / PD"/>
          </div>
        </div>

        <label>‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏ó‡∏µ‡∏°‡∏õ‡∏µ‡πÉ‡∏´‡∏°‡πà *</label>
        <textarea id="message" required maxlength="500" placeholder="‡∏ù‡∏≤‡∏Å‡∏≠‡∏∞‡πÑ‡∏£‡πÑ‡∏ß‡πâ‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡πâ‡∏≤‡∏≤‡∏≤ üéÜ"></textarea>

        <label>‡πÅ‡∏ô‡∏ö‡∏£‡∏π‡∏õ (optional)</label>
       <input 
              id="photo" 
              type="file" 
              accept="image/png,image/jpeg,image/jpg,image/heic,image/heif" >


        <div class="preview" id="preview">
          <img id="img" alt="preview"/>
        </div>

        <div class="actions">
          <button class="btn" type="submit">‡∏™‡πà‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡πà‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏£‡∏á‡∏à‡∏≥ ‚ú®</button>
          <button class="ghost" type="button" id="clear">‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>
        </div>

        <div class="hint">
          ‚úÖ ‡∏™‡πà‡∏á‡πÅ‡∏•‡πâ‡∏ß‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÄ‡∏Å‡πá‡∏ö‡πÉ‡∏ô Google Drive <br/>
          üîí ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏î‡∏π‡∏£‡∏π‡∏õ‡∏ú‡πà‡∏≤‡∏ô‡∏à‡∏≠ monitor ‡πÉ‡∏´‡∏ç‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢‡∏Ñ‡πà‡∏∞ ^^
        </div>

        <div class="status" id="status"></div>
      </form>
    </div>
  </div>

<script>
/** ====== CONFIG ====== */
const CONFIG = {
  WEBAPP_URL: "https://script.google.com/macros/s/AKfycbz9Qnruk5_qucZwhrNXgD00K7uL5qOwYfUMjnahY5HTZz0lp3TALMXhMILItEc8un5IVw/exec",
  EVENT_NAME: "NewYearEvent2026"
};

const $ = (id)=>document.getElementById(id);
const statusBox = $("status");
const preview = $("preview");
const img = $("img");

/* =================================================
 * ‚úÖ SAFE base64 (‡πÅ‡∏Å‡πâ Maximum call stack size exceeded)
 * ================================================= */
function arrayBufferToBase64(buffer) {
  let binary = "";
  const bytes = new Uint8Array(buffer);
  const chunkSize = 0x8000; // 32KB

  for (let i = 0; i < bytes.length; i += chunkSize) {
    binary += String.fromCharCode.apply(
      null,
      bytes.subarray(i, i + chunkSize)
    );
  }
  return btoa(binary);
}

/* ================= UI ================= */
$("photo").addEventListener("change", ()=>{
  const f = $("photo").files?.[0];
  if (!(f instanceof File)) {
    preview.style.display = "none";
    return;
  }
  img.src = URL.createObjectURL(f);
  preview.style.display = "block";
});

$("clear").addEventListener("click", ()=>{
  $("name").value="";
  $("team").value="";
  $("message").value="";
  $("photo").value="";
  preview.style.display="none";
  showStatus("", "ok", false);
});

function showStatus(text, kind="ok", show=true){
  statusBox.className = "status " + (kind==="ok" ? "ok" : "bad");
  statusBox.textContent = text;
  statusBox.style.display = show ? "block" : "none";
}

/* ================= IMAGE PROCESS ================= */
async function processImage(file) {
  if (!file || !(file instanceof File) || !file.type) return null;

  const type = file.type.toLowerCase();

  if (type === "image/png") return file;

  if (type === "image/jpeg" || type === "image/jpg") {
    if (file.size <= 3 * 1024 * 1024) return file;
    return compressJPG(file);
  }

  if (type === "image/heic" || type === "image/heif") {
    return convertHEICtoJPG(file);
  }

  return null;
}

function compressJPG(file) {
  return new Promise((resolve) => {
    const img = new Image();
    img.onload = () => {
      const maxW = 1600;
      const scale = Math.min(1, maxW / img.width);

      const canvas = document.createElement("canvas");
      canvas.width = img.width * scale;
      canvas.height = img.height * scale;

      canvas.getContext("2d").drawImage(img, 0, 0, canvas.width, canvas.height);

      canvas.toBlob(
        (blob) => {
          if (!blob) return resolve(file);
          resolve(new File(
            [blob],
            file.name.replace(/\.\w+$/, ".jpg"),
            { type: "image/jpeg" }
          ));
        },
        "image/jpeg",
        0.82
      );
    };
    img.onerror = () => resolve(file);
    img.src = URL.createObjectURL(file);
  });
}

async function convertHEICtoJPG(file) {
  try {
    const result = await heic2any({
      blob: file,
      toType: "image/jpeg",
      quality: 0.82,
    });
    const blob = Array.isArray(result) ? result[0] : result;
    return new File(
      [blob],
      file.name.replace(/\.(heic|heif)$/i, ".jpg"),
      { type: "image/jpeg" }
    );
  } catch {
    return null;
  }
}

/* ================= SUBMIT ================= */
$("form").addEventListener("submit", async (e) => {
  e.preventDefault();

  const name = $("name").value.trim();
  const team = $("team").value.trim();
  const message = $("message").value.trim();

  if (!name || !message) {
    showStatus("‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡πâ‡∏≤‡∏≤ ‚úçÔ∏è", "bad", true);
    return;
  }

  showStatus("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á... (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ô‡πá‡∏ï‡∏ä‡πâ‡∏≤‡∏≠‡∏≤‡∏à‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á)", "ok", true);

  const input = $("photo");
  let photo = input?.files?.[0] || null;

  if (photo instanceof File) {
    const processed = await processImage(photo);
    photo = processed instanceof File ? processed : null;
  }

  const fd = new FormData();
  fd.append("event", CONFIG.EVENT_NAME);
  fd.append("name", name);
  fd.append("team", team);
  fd.append("message", message);
  fd.append("clientTime", new Date().toISOString());

  if (input?.files?.length) {
    const originalFile = input.files[0];

    // ORIGINAL (full size)
    const originalB64 = arrayBufferToBase64(
      await originalFile.arrayBuffer()
    );
    fd.append("photoOriginalBase64", originalB64);
    fd.append("photoOriginalName", originalFile.name);
    fd.append("photoOriginalType", originalFile.type);

    // PREVIEW (compressed)
    if (photo instanceof File) {
      const previewB64 = arrayBufferToBase64(
        await photo.arrayBuffer()
      );
      fd.append("photoPreviewBase64", previewB64);
      fd.append("photoPreviewName", photo.name);
      fd.append("photoPreviewType", photo.type);
    }
  }

  try {
    const res = await fetch(CONFIG.WEBAPP_URL, {
      method: "POST",
      body: fd
    });

    const data = await res.json();
    if (!data?.ok) throw new Error(data?.error || "‡∏™‡πà‡∏á‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");

    showStatus("‡∏™‡πà‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à! ‡∏Ç‡∏≠‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏°‡∏≤‡∏Å üéÜ", "ok", true);
    $("message").value = "";
    $("photo").value = "";
    preview.style.display = "none";

  } catch (err) {
    showStatus("‡∏û‡∏±‡∏á‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á: " + err.message, "bad", true);
  }
});
</script>

</body>
</html>